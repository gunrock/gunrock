# Gunrock/Essentials Ubuntu Workflow - Sparse Checkout Test
# This workflow tests fetching ROCm HEADER-ONLY libraries via git sparse-checkout
# from the rocm-libraries monorepo instead of system packages.
#
# Fetched via sparse checkout (header-only): rocprim, rocthrust, hipcub
# Installed via system packages (compiled libs): hiprand, hipsparse, rocrand
name: Ubuntu Sparse Checkout Test

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master and dev branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  
jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-22.04]
        backend: [amd]
        include:
          - backend: amd
            architectures: "gfx950"
            cmake_backend_flag: "-DESSENTIALS_AMD_BACKEND=ON -DESSENTIALS_NVIDIA_BACKEND=OFF"
            cmake_arch_flag: "-DCMAKE_HIP_ARCHITECTURES=gfx950"
        
    # https://github.blog/changelog/2021-02-08-github-actions-skip-pull-request-and-push-workflows-with-skip-ci/
    if: "!contains(github.event.commits[0].message, '[skip ubuntu]')"
    runs-on: ${{matrix.os}}
    name: Build (AMD - Sparse Checkout)

    steps:
      # Install ROCm for AMD backend
      # Header-only libs (rocprim, rocthrust, hipcub) are fetched via sparse-checkout
      # Compiled libs (hiprand, hipsparse, rocrand) must be installed as system packages
      - name: Install ROCm
        uses: loostrum/rocm-installer@v0.2
        with:
          version: latest
          # Runtime + compiled libraries (header-only libs fetched via cmake)
          packages: rocm-hip-runtime-dev hiprand-dev hipsparse-dev rocrand roctracer

      - name: Check hipcc version
        run: hipcc --version

      - name: Verify header-only libs NOT installed (will be fetched via cmake)
        run: |
          echo "Verifying that HEADER-ONLY library headers are NOT installed via system packages..."
          echo "These will be fetched via cmake sparse-checkout from rocm-libraries"
          echo ""
          
          for lib in "rocprim" "thrust" "hipcub"; do
            if [ -d "/opt/rocm/include/$lib" ]; then
              echo "WARNING: $lib appears to be installed via system packages"
            else
              echo "OK: $lib not found in system - will be fetched via cmake"
            fi
          done
          
          echo ""
          echo "Compiled libraries should be installed via system packages:"
          for lib in "hiprand" "hipsparse" "rocrand"; do
            if [ -d "/opt/rocm/include/$lib" ]; then
              echo "OK: $lib installed via system packages"
            else
              echo "WARNING: $lib not found - may cause link errors"
            fi
          done
        
      - uses: actions/checkout@v6

      - name: Configure cmake (force sparse checkout)
        env:
          LD_LIBRARY_PATH: /opt/rocm/lib
        run: |
          cmake -B ${{github.workspace}}/build \
            -DESSENTIALS_BUILD_TESTS=ON \
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
            -DESSENTIALS_FORCE_GIT_FETCH_ROCM=ON \
            ${{matrix.cmake_backend_flag}} \
            ${{matrix.cmake_arch_flag}}
            
      - name: Verify sparse checkout was used
        run: |
          echo "Checking if rocm-libraries was cloned via sparse-checkout..."
          if [ -d "${{github.workspace}}/build/externals/rocm_libraries-src" ]; then
            echo "OK: Found rocm_libraries-src directory"
            ls -la ${{github.workspace}}/build/externals/rocm_libraries-src/
            if [ -d "${{github.workspace}}/build/externals/rocm_libraries-src/projects" ]; then
              echo "Projects directory contents:"
              ls -la ${{github.workspace}}/build/externals/rocm_libraries-src/projects/
            fi
          else
            # Try alternative location
            EXTERNAL_DIR=$(find ${{github.workspace}} -name "rocm_libraries-src" -type d 2>/dev/null | head -1)
            if [ -n "$EXTERNAL_DIR" ]; then
              echo "OK: Found rocm_libraries-src at $EXTERNAL_DIR"
              ls -la "$EXTERNAL_DIR"
            else
              echo "ERROR: rocm_libraries-src not found - sparse checkout may have failed"
              exit 1
            fi
          fi
        
      - name: Build all applications
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}}

      # =========================================================================
      # VERIFICATION: Prove we're using sparse-checkout libraries, not system ones
      # =========================================================================
      
      - name: Verify include paths point to sparse-checkout (CMake cache)
        run: |
          echo "=========================================="
          echo "VERIFICATION: CMake Cache Include Paths"
          echo "=========================================="
          echo ""
          
          BUILD_DIR="${{github.workspace}}/build"
          
          echo "Checking CMakeCache.txt for include directory settings..."
          echo ""
          
          for var in ROCPRIM_INCLUDE_DIR THRUST_INCLUDE_DIR HIPCUB_INCLUDE_DIR CUB_INCLUDE_DIR; do
            value=$(grep "^${var}:" "$BUILD_DIR/CMakeCache.txt" | cut -d'=' -f2)
            echo "$var = $value"
            
            if [[ "$value" == *"rocm_libraries-src"* ]]; then
              echo "  ✓ PASS: Points to sparse-checkout directory"
            elif [[ "$value" == *"/opt/rocm"* ]]; then
              echo "  ✗ FAIL: Points to system directory!"
              exit 1
            else
              echo "  ? Path doesn't match expected patterns"
            fi
            echo ""
          done

      - name: Verify generated version headers are ours
        run: |
          echo "=========================================="
          echo "VERIFICATION: Version Headers"
          echo "=========================================="
          echo ""
          
          ROCM_LIBS_DIR=$(find ${{github.workspace}} -name "rocm_libraries-src" -type d 2>/dev/null | head -1)
          
          if [ -z "$ROCM_LIBS_DIR" ]; then
            echo "ERROR: Cannot find rocm_libraries-src directory"
            exit 1
          fi
          
          echo "rocm_libraries-src found at: $ROCM_LIBS_DIR"
          echo ""
          
          # Check rocprim version header
          ROCPRIM_VERSION="$ROCM_LIBS_DIR/projects/rocprim/rocprim/include/rocprim/rocprim_version.hpp"
          echo "--- rocprim_version.hpp ---"
          if [ -f "$ROCPRIM_VERSION" ]; then
            head -10 "$ROCPRIM_VERSION"
            if grep -q "Auto-generated" "$ROCPRIM_VERSION"; then
              echo ""
              echo "✓ PASS: rocprim_version.hpp was generated by our cmake"
            else
              echo ""
              echo "? NOTE: Header exists but may not be auto-generated"
            fi
          else
            echo "ERROR: rocprim_version.hpp not found at $ROCPRIM_VERSION"
            exit 1
          fi
          echo ""
          
          # Check rocthrust version header
          ROCTHRUST_VERSION="$ROCM_LIBS_DIR/projects/rocthrust/thrust/rocthrust_version.hpp"
          echo "--- rocthrust_version.hpp ---"
          if [ -f "$ROCTHRUST_VERSION" ]; then
            head -10 "$ROCTHRUST_VERSION"
            if grep -q "Auto-generated" "$ROCTHRUST_VERSION"; then
              echo ""
              echo "✓ PASS: rocthrust_version.hpp was generated by our cmake"
            fi
          else
            echo "WARNING: rocthrust_version.hpp not found (may be in different location)"
          fi
          echo ""

      - name: Verify compile commands use sparse-checkout paths
        run: |
          echo "=========================================="
          echo "VERIFICATION: Compile Commands"
          echo "=========================================="
          echo ""
          
          BUILD_DIR="${{github.workspace}}/build"
          
          if [ -f "$BUILD_DIR/compile_commands.json" ]; then
            echo "Checking compile_commands.json for include paths..."
            echo ""
            
            # Extract a sample compile command and check includes
            echo "Sample include paths from first .cu file:"
            grep -o '\-I[^ ]*' "$BUILD_DIR/compile_commands.json" | sort -u | head -20
            echo ""
            
            # Check if rocm_libraries-src appears in includes
            if grep -q "rocm_libraries-src" "$BUILD_DIR/compile_commands.json"; then
              echo "✓ PASS: compile_commands.json references rocm_libraries-src"
            else
              echo "? NOTE: rocm_libraries-src not found in compile_commands.json"
              echo "  (This may be normal depending on how includes are resolved)"
            fi
            
            # Check that /opt/rocm/include/rocprim is NOT used
            if grep -q '"/opt/rocm/include/rocprim' "$BUILD_DIR/compile_commands.json"; then
              echo "✗ FAIL: compile_commands.json references system rocprim!"
              exit 1
            else
              echo "✓ PASS: No system rocprim paths in compile_commands.json"
            fi
            
            if grep -q '"/opt/rocm/include/thrust' "$BUILD_DIR/compile_commands.json"; then
              echo "✗ FAIL: compile_commands.json references system thrust!"
              exit 1
            else
              echo "✓ PASS: No system thrust paths in compile_commands.json"
            fi
          else
            echo "NOTE: compile_commands.json not found (CMAKE_EXPORT_COMPILE_COMMANDS may be OFF)"
          fi

      - name: Summary
        run: |
          echo "=========================================="
          echo "SPARSE CHECKOUT VERIFICATION COMPLETE"
          echo "=========================================="
          echo ""
          echo "If all checks above passed, the build is using:"
          echo "  - rocprim from sparse-checkout (not system)"
          echo "  - rocthrust from sparse-checkout (not system)"
          echo "  - hipcub from sparse-checkout (not system)"
          echo ""
          echo "Compiled libraries (hiprand, hipsparse) are from system packages as expected."
